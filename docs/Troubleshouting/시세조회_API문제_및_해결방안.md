# 시세 조회 기능 - API 문제 및 근본적 해결 방안

## 📌 문제 상황

사용자가 **쌀, 찹쌀, 참깨, 단감, 감귤, 호두** 등을 검색했을 때 "조회된 결과가 없습니다"라는 메시지가 표시되는 문제가 지속적으로 발생하고 있습니다.

## 🔍 근본 원인 분석

### 1. API 테스트 결과

**공공데이터포털 API** (`https://apis.data.go.kr/B552845/katRealTime/trades`)를 여러 파라미터로 테스트한 결과:

```json
{
  "테스트 결과": {
    "전체 데이터": "72,306건 (표시)",
    "실제 반환": "가지만 50건",
    "대분류 코드 01~12": "모두 동일한 결과 (가지만 반환)",
    "결론": "대분류 코드 필터링 미작동"
  }
}
```

### 2. API의 본질적인 제약

이 API는 **"실시간 경매 데이터"**를 제공합니다:
- **API 엔드포인트 이름**: `katRealTime/trades` (실시간 거래)
- **데이터 특성**: 현재 시점에 경매가 진행 중인 품목만 반환
- **시간대별 차이**: 아침에는 채소류, 오후에는 과일류 등 시간대별로 다른 품목 거래
- **계절성**: 특정 계절에만 거래되는 품목 (딸기, 수박 등)

### 3. 발견된 API 제약사항

| 제약사항 | 설명 | 영향 |
|---------|------|------|
| **대분류 코드 필터링 미지원** | `gds_lclsf_cd` 파라미터 무시 | 카테고리 검색 불가 |
| **실시간 데이터만 반환** | 현재 거래 중인 품목만 | 품목 다양성 매우 낮음 |
| **날짜 파라미터 제한** | 특정 날짜만 조회 가능 | 과거 데이터 접근 어려움 |

## 💡 근본적인 해결 방안

### ✅ 적용된 해결책: 날짜 범위 조회

**현재 구현된 방법** (2025-11-26 적용):

```typescript
// 최근 7일간의 데이터를 조회하여 품목 다양성 확보
if (searchParams.searchKeyword) {
  const today = new Date();
  const sevenDaysAgo = new Date(today);
  sevenDaysAgo.setDate(today.getDate() - 7);
  
  params.dateRange = { 
    from: sevenDaysAgo.toISOString().split('T')[0], 
    to: today.toISOString().split('T')[0] 
  };
  params.numOfRows = 1000; // 각 날짜별로 1000건씩 조회
}
```

**작동 방식**:
1. 사용자가 "사과" 검색
2. 최근 7일간의 데이터를 날짜별로 조회 (7번의 API 호출)
3. 모든 데이터를 합쳐서 "사과"를 포함하는 항목만 필터링
4. 중복 제거 후 사용자에게 표시

**장점**:
- ✅ 현재 API만으로 해결 가능
- ✅ 추가 인프라 불필요
- ✅ 품목 다양성 대폭 증가

**단점**:
- ⚠️ 7번의 API 호출로 응답 속도 2-3초 소요
- ⚠️ API 호출 횟수 증가 (부하 고려 필요)
- ⚠️ 여전히 특정 품목은 최근 7일간 거래 없을 수 있음

### 🔄 추가 개선 방안

#### 1. 날짜 범위 확장 (단기)

```typescript
// 7일 → 30일로 확장
sevenDaysAgo.setDate(today.getDate() - 30);
```

**효과**: 품목 다양성 더욱 증가, 계절 품목도 일부 포함 가능
**비용**: API 호출 30회 (응답 시간 8-10초 예상)

#### 2. 데이터 캐싱 (중기)

```typescript
// Supabase에 시세 데이터 저장
// 1시간마다 백그라운드에서 데이터 수집
// 사용자 요청 시 DB에서 조회
```

**효과**: 
- 빠른 응답 속도 (<1초)
- API 호출 횟수 대폭 감소
- 모든 품목의 최근 데이터 보장

**필요 작업**:
- Supabase 테이블 생성 (`market_prices`)
- Edge Function으로 주기적 데이터 수집
- 데이터 정제 및 중복 제거 로직

#### 3. 다른 API 병행 사용 (장기)

**KAMIS API** (한국농수산식품유통공사):
- 일별/월별/연도별 평균 가격 제공
- 품목별 조회 가능
- 과거 데이터 풍부

**장점**:
- 품목 다양성 보장
- 안정적인 데이터
- 과거 추이 분석 가능

**단점**:
- 실시간 데이터 아님 (하루 전 데이터)
- API 키 별도 발급 필요
- 두 API 통합 로직 필요

## 📊 현재 상태 및 다음 단계

### 현재 상태 (2025-11-26)
- ✅ 날짜 범위 조회 기능 구현 완료
- ✅ 최근 7일간 데이터 조회
- ✅ 중복 제거 및 클라이언트 필터링
- ✅ API 부하 방지 딜레이 (0.3초) 추가

### 테스트 필요
```bash
# 개발 서버 실행
pnpm dev

# 테스트 페이지 접속
http://localhost:3000/wholesaler/market-prices

# 검색 테스트
- "사과" 검색 → 최근 7일간 사과 거래 데이터 표시
- "쌀" 검색 → 최근 7일간 쌀 거래 데이터 표시
- 브라우저 콘솔(F12)에서 로그 확인
```

### 예상 결과
- **거래가 있었던 품목**: 정상적으로 데이터 표시
- **최근 7일간 거래가 없는 품목**: 여전히 "조회된 결과가 없습니다"
- **응답 시간**: 2-3초 (7번의 API 호출)

### 다음 단계 추천

**즉시 가능한 개선** (우선순위 高):
1. 날짜 범위를 14일 또는 30일로 확장 → 품목 다양성 증가
2. 로딩 UI 개선 → 사용자 경험 향상
3. 결과 없을 때 안내 메시지 개선:
   ```
   "최근 30일간 거래 데이터가 없습니다. 
   해당 품목은 현재 거래되지 않거나 계절 품목일 수 있습니다."
   ```

**중기 개선** (1-2주 내):
1. Supabase 캐싱 구현
2. Edge Function으로 1시간마다 데이터 수집
3. 응답 속도 1초 미만으로 개선

**장기 개선** (1개월 내):
1. KAMIS API 통합
2. 두 API 데이터 병합 전략 수립
3. 과거 데이터 분석 및 추이 그래프 제공

## 🎯 사용자 신뢰성 확보 방안

### 1. 명확한 안내
```tsx
// 검색 결과 없을 때
<Alert>
  <AlertTitle>조회 결과가 없습니다</AlertTitle>
  <AlertDescription>
    "{searchKeyword}"는 최근 7일간 거래 데이터가 없습니다.
    해당 품목은 현재 거래되지 않거나 계절 품목일 수 있습니다.
  </AlertDescription>
</Alert>
```

### 2. 로딩 상태 표시
```tsx
// 검색 중일 때
<div className="flex items-center gap-2">
  <Spinner />
  최근 7일간의 시세 데이터를 조회하고 있습니다...
</div>
```

### 3. 데이터 출처 및 갱신 시간 표시
```tsx
<div className="text-xs text-muted-foreground">
  데이터 출처: 공공데이터포털 전국 공영도매시장 실시간 경매정보
  조회 기간: {dateRange.from} ~ {dateRange.to}
  마지막 갱신: {lastUpdated}
</div>
```

## 📝 결론

**현재 적용된 해결책**은 API의 제약사항을 우회하여 품목 다양성을 확보하는 최선의 방법입니다.

**하지만**:
- 응답 속도 개선 필요 → **캐싱 도입** 추천
- 모든 품목 보장 불가 → **KAMIS API 병행** 고려
- 사용자 신뢰성 → **명확한 안내 메시지** 필수

**즉시 테스트 가능**하며, 사용자 피드백을 받아 추가 개선을 진행할 수 있습니다.

