# TODO - 소매점(Retailer) 기능 개발

 프로젝트 MarketLink 소매점 사이트
 업데이트 2024-12-XX (PRD 기반 재정비)
 문서 [RE_PRD.md](docsretailerRE_PRD.md) 참조

---

## 📋 개발 로드맵

```
Phase 1 인증 & 기본 구조 (완료)
Phase 2 상품 탐색 & 장바구니 (완료)
Phase 3 주문 & 결제 (진행 중)
Phase 4 거래 관리 & 마이페이지 (진행 중)
Phase 5 AI & 최적화 (예정)
```

---

## Phase 1 인증 & 진입 (R.AUTH) 🔐

PRD 3.0 섹션 참조.

### 1.1 인증 시스템 (R.AUTH.01)

- [X] Clerk 초기 설정
  - [X] Clerk 프로젝트 연동 및 환경변수 설정
  - [X] 로그인회원가입 페이지 (`sign-in`, `sign-up`)
  - [X] 한국어 로컬라이제이션
- [X] 소매점 역할 관리
  - [X] 역할 선택 페이지 (`role-selection`)
  - [X] 소매점(`retailer`) 메타데이터 연동
- [X] 도매 계정 중복 가입 차단
  - [X] 회원가입 페이지에서 도매 계정 감지 로직
  - [X] 도매 계정 중복 가입 시 차단 모달 표시
  - [X] 모달에서 도매점 로그인 페이지로 이동 옵션 제공
- [X] 일반 중복 가입 처리
  - [X] 이미 가입된 계정으로 회원가입 시도 시 모달 표시
  - [X] "이미 가입된 계정입니다" 모달 UI 구현
  - [X] 모달에서 로그인 페이지로 이동 기능 구현

### 1.2 진입 및 보안 (R.AUTH.02, R.AUTH.03)

- [X] 초기 리다이렉트 (R.AUTH.02)
  - [X] 로그인 시 `retailerdashboard`로 이동
  - [X] 미인증 사용자 접근 차단 (Middleware)
- [ ] 데이터 접근 권한 (R.AUTH.03)
  - [ ] Supabase RLS 정책 수립 (본인 주문만 조회)
  - [ ] 도매점 PII(개인정보) 접근 차단 정책

### 1.3 레이아웃구조

- [X] Retailer 공통 레이아웃
  - [X] `retailer` 경로 레이아웃 (`layout.tsx`)
  - [X] 모바일 대응 사이드바헤더 (`page-header.tsx`, `sidebar.tsx`)
  - [X] 페이지별 동적 타이틀 처리
  - [X] 사이드바 사용자 프로필 메뉴
    - [X] 상단 프로필 영역 (아바타, 이름, 이메일)
    - [X] 하단 고정 메뉴 (프로필 수정, 로그아웃)
    - [X] 로그아웃 시 소매업자 로그인 페이지로 리다이렉트

---

## Phase 2 대시보드 & 상품 탐색 🛒

PRD 3.1, 3.2, 3.3 섹션 참조.

### 2.1 대시보드 (R.DASH)

- [X] Bento Grid 레이아웃 (R.DASH.01)
  - [X] 반응형 대시보드 UI 구현
- [X] AI 추천 상품 (R.DASH.02)
  - [X] 추천 상품 UI 카드 구현
  - [X] 지금 구매해야 할 상품 리스트
- [X] 주문알림 요약 (R.DASH.03, R.DASH.04)
  - [X] 최근 주문 상태 요약 컴포넌트
  - [X] 재고 부족긴급 공지 알림 UI
- [X] 배송 조회 기능
  - [X] 실시간 배송 조회 페이지 구현 (`/retailer/delivery-tracking`)
  - [X] 배송 상태 요약 (송장번호, 도착 예정 시간)
  - [X] 배송 타임라인 시각화 (배송출발 → 터미널도착 → 배송중 → 배송완료)
  - [X] 택배사 정보 및 배송 물품 표시
  - [X] 대시보드 배송 카드 클릭 시 배송 조회 페이지로 이동
- [X] 대시보드 기능 정리
  - [X] 실시간 시세표 삭제
  - [X] 긴급 알림 삭제
  - [X] 월별 구매 추이 차트 삭제
- [X] 레이아웃 구조 개선
  - [X] 사이드바 완전 삭제
  - [X] 헤더에 네비게이션 메뉴 통합
  - [X] "대시보드" → "홈"으로 변경
  - [X] 반응형 헤더 네비게이션 구현 (데스크톱: 가로 메뉴, 모바일: 햄버거 메뉴)
- [X] HOT DEAL 섹션 실데이터 연동 (Supabase 최신순 4개 노출)
- [X] 최근 주문 섹션 실데이터 연동 및 목데이터 제거 (프로필과 동일)
- [X] Gemini 챗봇 플로팅 위젯 (우측 하단, 대시보드 전용)
  - [X] 서버 프록시(API) → Gemini Flash 2.x 호출 (env: `GEMINI_API_KEY`, 선택 `GEMINI_MODEL_NAME`)
  - [X] 다크/라이트 대응, 전송/응답 로그 최소 노출
  - 위치: `/retailer/dashboard` 화면 오른쪽 하단 원형 버튼 → 패널
  - [X] 관리자 문의 전송 지원 (제목/내용, 주문 ID 옵션) → Supabase `inquiries` 저장

### 2.2 상품 검색 (R.SEARCH)

- [X] Smart Search (R.SEARCH.01)
  - [X] Command Palette (`Cmd+K`) 구현
  - [X] 상품명카테고리 검색 기능
  - [X] 헤더 검색창 placeholder 텍스트 변경 ("Q 품목이나 거래처를 검색하세요" → "상품명이나 거래처를 검색하세요")
- [X] 상품 리스트 & 필터 (R.SEARCH.02, R.SEARCH.03)
  - [X] 상품 목록 페이지 UI
  - [X] 카테고리배송 필터링 UI
  - [X] 카테고리별 서브탭 제거 (과일/채소/수산물/곡물·견과)
- [X] 상품 상세 & 익명화 (R.SEARCH.04)
  - [X] 상품 상세 페이지 구현
  - [X] 도매점 정보 익명화 처리 (예 Partner #F2B-01)
  - [X] 실제 DB 데이터 연동 (데모 데이터 제거)
  - [X] 상품 목록 페이지 재고 표시 수정 (stock_quantity 필드 사용)
  - [X] "전체" 카테고리 버튼 클릭 시 상품 목록 표시 오류 수정
    - [X] initialCategory 동기화 추가
    - [X] updateURL 함수에서 "all" 값 처리 로직 수정
  - [X] 샤인머스켓 상세 레이아웃 시안 반영 (desktop/mobile)
- [X] 장바구니 담기 (R.SEARCH.05)
  - [X] 수량 선택 및 장바구니 추가 버튼
  - [X] 상품 목록 페이지에서 장바구니 추가 기능 구현
    - [X] 장바구니 담기 버튼 클릭 시 상세 페이지로 이동 (수량 선택 후 장바구니 추가는 상세 페이지에서 진행)
  - [X] 상품 상세 페이지에서 장바구니 담기 기능 구현
    - [X] 수량 선택 (1부터 재고까지)
    - [X] 장바구니 담기 버튼 클릭 시 장바구니 페이지로 이동
    - [X] 바로구매 버튼 클릭 시 결제 페이지로 이동
    - [X] 최소 주문 수량 안내 카드 (상품 액션 영역) 추가
  - [X] 장바구니 추가 후 장바구니 페이지로 자동 이동
  - [X] 연말 특가 카드 담기 버튼 클릭 시 장바구니 페이지 이동 (`/retailer/products?special=true`)
- [X] 베스트 랭킹 페이지 (R.SEARCH.06)
  - [X] 베스트 상품 조회 함수 추가 (`getAllBestRetailerProducts`)
  - [X] 베스트 페이지 레이아웃 구현 (`?sort=popular` 파라미터 처리)
  - [X] 이벤트 배너 컴포넌트 (보라색 그라디언트 배경)
  - [X] 이벤트 배너 이미지 Unsplash 과일/채소 사진으로 교체
  - [X] 1-3위 상품 카드 컴포넌트 (세로형 그리드, 순위 뱃지)
  - [X] 4-10위 상품 리스트 컴포넌트 (가로형 리스트, 장바구니 버튼)
  - [X] 반응형 디자인 적용 (모바일/데스크톱)
- [X] 연말 특가 페이지 (R.SEARCH.08)
  - [X] `?special=true` 파라미터 처리 및 전용 레이아웃
  - [X] 시안 기반 배너/타이머/특가 카드 UI 적용 (이미지 변경, 기능 유지)
- [X] 단독관 페이지 (R.SEARCH.07)
  - [X] 단독관 페이지 레이아웃 구현 (`?exclusive=true` 파라미터 처리)
  - [X] 단독관 이벤트 배너 컴포넌트 (보라색 그라디언트 배경)
  - [X] 카테고리 아이콘 메뉴 컴포넌트 (6개 아이콘: 재구매많은, 단독특가, 베스트랭킹, 산지직송, 리뷰좋은, 대용량)
  - [X] 단독관 전용 상품 카드 컴포넌트 (태그 표시: Only, 단독특가, 선물추천)
  - [X] 중간 배너 컴포넌트 (팜투비즈 X 명품 농장, 카테고리 배너)
  - [X] 섹션별 상품 그리드 구현 (팜투비즈 단독 상품, 지금 뜨는 단독 상품, 선물하기 좋은 패키지)
  - [X] 반응형 디자인 적용 (모바일/데스크톱)
- [X] 검색 결과 없음 화면을 시안대로 업데이트
  - [X] 빈 상태 UI 리디자인 및 다크 모드 대응
  - [X] \"홈으로 돌아가기\" 버튼 초록색 적용 및 대시보드(`/retailer/dashboard`) 이동

### 2.3 장바구니 (R.CART)

- [X] 장바구니 관리 (R.CART.01, R.CART.02)
  - [X] 장바구니 목록 UI
  - [X] 수량 변경 및 삭제 기능
    - [X] 수량 증가/감소 버튼 동작 구현
    - [X] 최소 주문 수량 및 재고 검증
    - [X] 상품 삭제 기능 구현
  - [X] 전체 선택 기능
    - [X] 전체 선택/해제 기능 구현
    - [X] 개별 선택/해제 기능 구현
    - [X] 선택 삭제 기능 구현
    - [X] 선택된 항목만 주문 요약에 반영
  - [X] 상태 관리 (ZustandLocal Storage)
- [X] 주문 예상 (R.CART.03, R.CART.04)
  - [X] 예상 결제 금액 계산
  - [X] 최소 주문 수량 검증
- [X] 장바구니 디자인 개선 (디자인 핸드오프 반영)
  - [X] 헤더: 장바구니 아이콘 + 제목 + 상품 수 서브텍스트
  - [X] 상품 카드: 둥근 카드 스타일, 오늘출발 배지, 단가 표시
  - [X] 수량 조절: 깔끔한 버튼 스타일 (- / 숫자 / +)
  - [X] 주문 금액: 상품 금액 + 배송비(무료) 구조
  - [X] 결제 버튼: "₩금액 결제하기 →" 스타일
  - [X] 안내 문구: 하단 3가지 안내 문구 추가
  - [X] 반응형 디자인: 모바일/데스크톱 레이아웃 최적화

---

## Phase 3 주문 & 결제 💳

PRD 3.4 섹션 참조.

### 3.1 주문서 작성 (R.ORDER.01, R.ORDER.02)

- [X] 주문서 UI
  - [X] 주문 상품 요약 표시
    - [X] 실제 장바구니 데이터 연동
    - [X] 장바구니 비어있을 시 리다이렉트 처리
  - [X] 배송지 정보 입력 폼
  - [X] 페이지 헤더 제목 설정 (주문/결제 페이지 → "결제"로 표시)
- [X] 배송 옵션 (R.ORDER.01)
  - [X] 새벽/일반 배송 선택 UI (현재는 새벽배송 고정, UI 제거)
- [X] 배송 시간 (R.ORDER.02)
  - [X] 배송 희망 시간 선택 UI (현재는 06:00-07:00 고정)

### 3.2 결제 처리 (R.ORDER.03-05)

- [X] 결제 수단 선택 (R.ORDER.03)
  - [X] 결제 수단(카드간편결제) 선택 UI
  - [X] 결제 버튼 클릭 핸들러 구현 (기본 구조)
- [X] PG 연동 (R.ORDER.03)
  - [X] Toss Payments SDK 설치 및 연동
  - [X] 결제 승인실패 처리
  - [X] 토스 결제 테스트 페이지 구현 (`/retailer/payment/test`)
    - [X] 임시 토스 결제 테스트 페이지 생성
    - [X] 나중에 실제 결제 플로우와 연결 가능하도록 구조화
- [X] 배송비 0원 정책 반영
  - [X] 주문 생성 시 shipping_fee 기본값 0으로 보정 (pendingOrder → createOrder)
  - [X] 결제 요청 저장 시 shipping_fee 0 보정 (pendingOrderData)
  - [X] create-order 서버 액션 shipping_fee 기본 0 보정
- [X] 주문 생성 (R.ORDER.05)
  - [X] 주문 데이터 검증 및 DB 생성 (Server Action)
    - [X] DB 마이그레이션: orders 테이블에 delivery_option, delivery_time, payment_key, paid_at 필드 추가
    - [X] create-payment.ts: 서버 측 가격/재고 검증 (데이터 무결성)
    - [X] create-order.ts: 결제 성공 후 주문 생성 Server Action
    - [X] 결제 성공 페이지: 주문 생성 및 장바구니 비우기 연동
    - [X] 주문 내역 페이지 연동 (생성된 주문 조회 가능)

---

## Phase 4 거래 관리 & 마이페이지 📦

PRD 3.5 섹션 참조.

### 4.1 주문 내역 (R.MY.01, R.MY.02)

- [X] 주문 목록 조회 (R.MY.01)
  - [X] 주문 리스트 UI 및 상태 필터
    - [X] 상태 필터 버튼 기능 (전체, 주문완료, 배송중, 배송완료, 주문취소)
    - [X] 상태별 필터링 로직 구현
  - [X] 주문 상세 페이지 UI
  - [X] 상품명 및 주문번호 검색 기능 (R.SEARCH.01)
    - [X] 검색창 UI 구현
    - [X] 실시간 검색 필터링 로직
    - [X] 상품명 및 주문번호 검색 지원
    - [X] 검색과 상태 필터 동시 적용 지원
- [X] 배송 타임라인 (R.MY.02)
  - [X] 주문 진행 상태 타임라인 시각화

### 4.2 구매 확정 (R.MY.03)

- [X] 구매 확정 프로세스
  - [X] 구매 확정 버튼 및 확인 모달
  - [X] 구매 확정 처리 Action

### 4.3 마이페이지

- [X] 프로필 관리
  - [X] 내 정보 수정 페이지
  - [X] 배송지 관리 기능
  - [X] 계정 관리 카드에서 로그아웃 버튼 제거 (비밀번호/계정 삭제만 노출)
  - [X] 프로필 페이지 텍스트 크기 조정 (1.5배 축소)

### 4.4 고객센터 (R.AI.01 관련)

- [X] 고객센터 페이지 구현
  - [X] 새 문의 작성 폼
  - [ ] 내 문의 내역 조회 (리뉴얼 후 재도입 예정)
  - [X] 탭 전환 UI
  - [X] 파일 첨부 기능
  - [X] AI 답변 생성 기능
    - [X] Gemini API 연동
    - [X] 문의 유형별 프롬프트 템플릿
    - [X] 도매 관련 질문 필터링
    - [X] Server Action으로 문의 저장 및 AI 답변 생성
  - [X] 피드백 기능
    - [X] "네"/"아니요" 버튼 클릭 표시 (배경색 채우기)
    - [X] 피드백 저장 기능
    - [X] 중복 클릭 방지 (한 번만 선택 가능)
  - [X] 고객센터 UI 리뉴얼
    - [X] 디자인 시안 반영(연락처 카드, FAQ 카테고리/아코디언, 1:1 문의 섹션)
    - [X] 반응형 적용 (데스크톱/모바일)

---

### 🛠 최근 수정 로그
- 2025-12-11: 배송비 계산을 공용 유틸로 통합하고 상품 상세/장바구니/결제에서 배송비 포함 총액을 표시 (shipping_fee * 수량 반영)
- 2025-12-11: 주문 상세 mock 제거, Supabase 실데이터 연동으로 최근 주문과 상세 일치
- 2025-12-11: 장바구니의 "쇼핑 계속하기" 이동 경로를 `/retailer/dashboard`로 변경
- 2025-12-11: `곡물/견과류` 카테고리를 정확 일치로 조회하도록 쿼리 수정 (하위 카테고리 OR 조건 제거)
- 2025-12-11: 카테고리 쿼리 파라미터를 `곡물/견과류`로 통일하고 필터/헤더/서브탭 로직을 동일하게 반영
- 2025-12-10: 주문 완료 화면의 "쇼핑 계속하기" 이동 경로를 `/retailer/dashboard`로 변경
- 2025-12-10: pnpm-lock.yaml 동기화로 Vercel `pnpm install` 실패 해결 (@tosspayments/tosspayments-sdk 교체 반영)
- 2025-12-10: 결제 완료 시 주문 완료 페이지 디자인 적용 및 즉시 노출
- 2025-12-09: 주문/결제 페이지에 소매점 정보(상호/주소/연락처) 표시
- 2025-12-09: 계정 관리 섹션에 Clerk 로그아웃 버튼 연결
- 2025-12-09: 로그아웃 리다이렉트 URL을 /sign-in/retailer 로 변경
- 2025-12-09: 계정 관리 카드의 '계정 삭제' 문구를 '회원 탈퇴'로 변경
- 2025-12-09: 기타 설정/계정 관리 카드 순서 변경
- 2025-12-09: 프로필 폼 클라이언트 전용 로드(SSR hydration 오류 방지)
- 2025-12-09: 중복된 기타 설정 카드 제거
- 2025-12-09: 기타 설정 섹션을 배송지/결제 수단/언어 및 통화 3개 카드로 업데이트
- 2025-12-09: 알림 설정 섹션에 토글 UI 적용 (주문/프로모션/뉴스레터/SMS)
- 2025-12-09: 소매 프로필 페이지 레이아웃 재구성 (배송지 제거 후 설정형 카드 구조 적용)
- 2025-12-09: 소매 프로필 페이지에서 배송지 관리 탭 제거 (회원정보 수정만 노출)
- 2025-12-08: Clerk SignIn props 정리 (redirectToSignUpUrl 제거로 타입 에러 해결)
- 2025-12-08: page-header 빈 인터페이스 제거로 ESLint 에러 해결
- 2025-12-08: Vercel 빌드 TypeScript 에러 수정 (original_name 필드 제거)
  - RetailerProduct 타입에 존재하지 않는 original_name 속성 참조 제거
  - 수정된 파일:
    - components/retailer/exclusive-product-card.tsx
    - components/retailer/command-palette.tsx
    - components/retailer/best-list-item.tsx
    - components/retailer/best-top-three-card.tsx
    - components/retailer/best-product-card.tsx
    - components/retailer/product-card.tsx
- 2025-12-08: Vercel 빌드 ESLint 경고/에러 정리 (따옴표 이스케이프, 미사용 변수 정리, 의존성 배열 보완)
- 2025-12-11: Vercel 빌드 ESLint/TS 오류 정리
  - 미사용 컴포넌트/아이콘 임포트 제거: app/retailer/profile/edit/page.tsx, components/retailer/profile/MyPage.tsx
  - 문의 작성 타입 불일치 수정: app/retailer/cs/InquiryForm.tsx (`type` 필드 제거, CreateInquiryInput에 맞춤)

## Phase 5 AI & 최적화 🤖

PRD 3.6 섹션 참조.

### 5.1 AI 인터페이스 (R.AI)

- [ ] AI 챗봇 (R.AI.01, R.AI.02)
  - [ ] Floating Action Button (FAB)
  - [ ] Command Palette 통합 질의
- [ ] 지능형 응답 (R.AI.03, R.AI.04)
  - [ ] 배송 가능 여부 질의 처리
  - [ ] 응답 내 PII 마스킹 처리

### 5.2 최적화 및 테스트

- [ ] 성능 최적화
  - [ ] 이미지 최적화 및 Lazy Loading
  - [ ] Supabase Storage 이미지 도메인 설정
    - [ ] `next.config.ts`의 `images.remotePatterns`에 Supabase Storage 도메인 추가
    - [ ] 예 `{ hostname .supabase.co, protocol https }` 또는 특정 프로젝트 도메인
    - [ ] Next.js Image 컴포넌트에서 Supabase Storage 이미지 사용 시 필수 설정
- [ ] 테스트
  - [ ] 주요 시나리오 E2E 테스트

---

 Note 이 문서는 소매점(Retailer) 기능 개발만을 추적합니다. 도매점 및 관리자 기능은 포함되지 않습니다.
